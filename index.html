<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM32 RTC Scheduler: STM32 RTC Scheduler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">STM32 RTC Scheduler
   </div>
   <div id="projectbrief">RTC-based scheduler for ultra-low power applications</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">STM32 RTC Scheduler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This project demonstrates how to implement an RTC-based scheduler for ultra-low power applications, where recurring tasks are needed to be executed with long periods.</p>
<p>Increasing number of applications, including IoT applications use real-time operating systems (RTOS) due to the ever-increasing complexity. However, achieving truly ultra-low power consumption while utilizing an RTOS is not trivial. This example uses FreeRTOS to show how to combine the RTC Scheduler with an RTOS, while maintaining ultra-low power dissipation when the device is in low power mode.</p>
<p>The RTC Scheduler is demonstrated on the STM32L496-Discovery board <a href="#references">[1]</a>.</p>
<p>Please refer to <a href="https://akospasztor.github.io/stm32-rtc-scheduler">https://akospasztor.github.io/stm32-rtc-scheduler</a> for complete documentation of the source code.</p>
<p><img src="https://dev.azure.com/akospasztor/stm32-rtc-scheduler/_apis/build/status/akospasztor.stm32-rtc-scheduler?branchName=master" alt="Build Status" class="inline"/></p>
<h1>Table of Contents</h1>
<ul>
<li><a href="#scheduler-operation">Scheduler Operation</a></li>
<li><a href="#example-application">Example Application</a></li>
<li><a href="#source-code-organization">Source Code Organization</a></li>
<li><a href="#compile-and-build">Compile and Build</a></li>
<li><a href="#references">References</a></li>
</ul>
<h1>Scheduler Operation</h1>
<p>The RTC Scheduler uses the Real-Time Clock peripheral to implement an efficient scheduling mechanism. It has a configurable alarm feature that can be configured to generate an interrupt on a specific date, with sub-second precision. Furthermore, the RTC has the advantage of being able to run even in ultra-low power consumption modes of the microcontroller.</p>
<p>The RTC Scheduler can be configured to schedule several, recurring jobs. The phrase "job" is used throughout this demonstration for <em>tasks</em> that are scheduled by the RTC Scheduler and the expression "task" is reserved for the actual tasks of the RTOS.</p>
<p>Upon launching the Scheduler, it checks all jobs and selects the job that needs to be executed the earliest. Then it configures an RTC alarm with the required date and time when the application needs to execute this job. If nothing else is to be done, the application can put the microcontroller into an ultra-low power mode. The RTC peripheral generates an alarm interrupt, thus waking up the microcontroller from the low power mode when the earliest job is due for execution.</p>
<p>After wakeup, the Scheduler checks all the jobs and marks those which are due for execution, i.e. their remaining time until next execution is zero. Then, the Scheduler adjusts the remaining time of all jobs and schedules the next job that needs to be executed by configuring and setting the RTC alarm to the next wakeup time. Afterwards the application processes the jobs that are pending for execution. If the application is done with all its operation and has nothing else to do until the next wakeup, it can put the microcontroller again into an ultra-low power mode and wait for the next RTC alarm interrupt.</p>
<h1>Example Application</h1>
<p>The example application utilizes FreeRTOS as its real-time operating system and it has two demo tasks. The first task blinks the <code>LD3</code> LED on the discovery board twice with a 0.5 second period. The second task turns on the <code>LD2</code> LED for 1 second, leaves it on, then turns it off. After executing their operations, each task waits and blocks for a so-called task notification <a href="#references">[2]</a> to be unblocked again.</p>
<p>The goal of this demonstration is to unblock the first task and execute it with a period of 5 seconds, and unblock the second task and execute it with a period of 10 seconds. During the time when nothing else is to be done, i.e. no task is to be executed by the RTOS, the microcontroller is put into the STOP2 ultra-low power mode, where it consumes less than 3 uA with the RTC enabled and running.</p>
<p><object type="image/svg+xml" data="docs/img/stm32-rtc-scheduler.svg" style="pointer-events: none;">STM32 RTC Scheduler</object></p>
<p><em>Figure 1: STM32 RTC Scheduler</em></p>
<h2>Detailed Description</h2>
<p>After startup, the application configures all the required peripherals, including the system clocks, GPIOs and the RTC peripheral. Then it configures the scheduler with two jobs:</p>
<ol type="1">
<li>A job with 5 second period with a callback function that unblocks the first RTOS task that blinks the <code>LD3</code> LED twice.</li>
<li>A job with 10 second period with a callback function that unblocks the second RTOS task that turns on the <code>LD2</code> LED for one second.</li>
</ol>
<p>Then the application configures the two RTOS tasks and launches the RTOS. Right after the RTOS starts, the RTOS startup hook is immediately called once by the kernel. In this hook, the RTC Scheduler is started by processing it the first time and the RTC alarm is configured to generate an interrupt for the job that needs to be executed the earliest.</p>
<p>The RTOS idle task is run by the RTOS kernel if nothing else is to be done. Every time the idle task runs, it checks what is the expected idle time of the RTOS kernel. If this expected idle time is greater than 1 second, furthermore the delayed task list of the RTOS is empty, the application puts the microcontroller into the STOP2 ultra-low power mode by pausing the RTOS tick (the SysTick), deinitializing all peripherals (except the RTC), resetting the system clock to 4 MHz (clocked directly by the MSI clock) and finally executing the <code>WFI</code> instruction.</p>
<p><em>Note:</em> In order to perform the above checks in the idle task, the RTOS kernel had to be extended by two additional functions. These additions can be found in the <code><a class="el" href="freertos__tasks__c__additions_8h.html" title="This file contains the additional code that needs to be inserted into the FreeRTOS tasks....">freertos_tasks_c_additions.h</a></code> file which is automatically included at the end of the <code>tasks.c</code> file of FreeRTOS. For more information, please refer to the <code>tasks.c</code> file.</p>
<p>When the RTC alarm interrupt arrives, the application resumes its operation by reconfiguring the microcontroller clocks and peripherals and enabling the RTOS tick. Within the RTC interrupt context, the RTC Scheduler is immediately processed, thus the RTC alarm is configured to generate the next wakeup interrupt when the next job is due and flags the jobs that need to be executed.</p>
<p>The application executes the pending jobs that are flagged for execution within the interrupt service routine, by calling the <code><a class="el" href="scheduler_8h.html#ac73d0e62bf6bf2ac8806c6bcd370f528" title="Execute the pending jobs.">SchedulerExecutePendingJobs()</a></code> function. This requires that the callbacks of all jobs are written to be executed from an interrupt context, meaning that they do not block, furthermore they only call interrupt-safe FreeRTOS API functions.</p>
<p>Depending on the application requirements, the execution of the pending jobs can be performed from task context as well. This can be useful if the job callbacks are required to block, or they need to call FreeRTOS API functions that are not interrupt-safe. In this case, the execution of the <code><a class="el" href="scheduler_8h.html#ac73d0e62bf6bf2ac8806c6bcd370f528" title="Execute the pending jobs.">SchedulerExecutePendingJobs()</a></code> function can be deferred to an RTOS task. This method is called <em>Deferred Interrupt Processing</em> <a href="#references">[3]</a>.</p>
<p>After executing the callbacks of the pending jobs, the respective FreeRTOS tasks are unblocked and run. If there is no more operation left and no task is ready to be run, the idle task of the RTOS puts the microcontroller again into STOP2 mode and waits for the next RTC alarm interrupt.</p>
<h1>Source Code Organization</h1>
<div class="fragment"><div class="line">Repository</div>
<div class="line">├── docs</div>
<div class="line">├── drivers</div>
<div class="line">│   ├── CMSIS</div>
<div class="line">│   └── STM32L4xx_HAL_Driver</div>
<div class="line">├── include</div>
<div class="line">├── lib</div>
<div class="line">│   └── FreeRTOS</div>
<div class="line">├── projects</div>
<div class="line">│   ├── EWARM</div>
<div class="line">│   ├── GCC</div>
<div class="line">│   └── MDK-ARM</div>
<div class="line">├── python</div>
<div class="line">├── source</div>
<div class="line">└── tests</div>
</div><!-- fragment --><p>The <code>docs</code> folder contains the generated documentation of the RTC Scheduler source code and other documentation-related static files.</p>
<p>The <code>drivers</code> folder contains the CMSIS (Cortex Microcontroller Software Interface Standard) as well as the HAL (Hardware Abstraction Layer) drivers from ST.</p>
<p>The RTC Scheduler source code and corresponding header files can be found in the <code>source</code> and <code>include</code> folders respectively.</p>
<p>The <code>lib</code> folder contains the source code of FreeRTOS.</p>
<p>The <code>projects</code> folder contains compiler and SDK-specific files organized in subfolders for IAR, Keil and GCC for ARM toolchains.</p>
<p>The <code>python</code> folder contains helper scripts and the <code>test</code> folder contains tests for the project.</p>
<h1>Compile and Build</h1>
<p>The project can be compiled and built out-of-the-box with IAR EWARM, Keil MDK-ARM and GNU Arm Embedded Toolchain. The IAR EWARM and Keil uVision projects are already configured with the required parameters and options in order to compile and build the application with a single click.</p>
<h2>IAR EWARM</h2>
<ol type="1">
<li>Open the <code>Project.eww</code> workspace file with IAR.</li>
<li>Configure the debugger within the project options.</li>
<li>Build the project and download to the target.</li>
</ol>
<h2>Keil uVision</h2>
<ol type="1">
<li>Open the <code>stm32-rtc-scheduler.uvprojx</code> project file with uVision.</li>
<li>Configure the debugger within the project options.</li>
<li>Build the project and download to the target.</li>
</ol>
<h2>GNU Arm Embedded Toolchain</h2>
<p>The <code>GCC</code> subfolder contains the compiler-specific files, a <code>Makefile</code> and a <code>SConscript</code> file to easily compile and build the project with the GNU Arm Embedded Toolchain.</p>
<p>Prerequisites:</p><ul>
<li>GNU Arm Embedded Toolchain, tested version: 8-2019-q3-update</li>
<li>At least one of the followings:<ul>
<li>GNU Make (for Windows, see: <a href="http://gnuwin32.sourceforge.net/packages/make.htm">Make for Windows</a>)</li>
<li>Python with pip</li>
</ul>
</li>
</ul>
<h3>Build with Make</h3>
<p>Steps to compile and build with GNU Make:</p>
<ol type="1">
<li>If the GNU Arm Embedded Toolchain has not been added to PATH: Edit the <code>CUSTOMPATH</code> variable in the <code>Makefile</code> so that it points to the <code>bin</code> folder of the installed GNU Arm Embedded Toolchain.</li>
<li>Open up your favorite terminal and navigate to the <code>GCC</code> subfolder where the makefile is located.</li>
<li>Type <code>make</code> and hit enter.</li>
<li>The <code>build</code> subfolder should contain the binary, ELF and HEX output files, named <code>stm32-rtc-scheduler.bin</code>, <code>stm32-rtc-scheduler.elf</code> and <code>stm32-rtc-scheduler.hex</code> respectively.</li>
</ol>
<h3>Build with SCons</h3>
<p>This project currently supports two build configurations: debug (default) and release. Follow these steps to compile and build the project with SCons. Please note that the recommended usage is within a virtualenv.</p>
<ol type="1">
<li>Install the requirements: <code>pip install -r requirements.txt</code></li>
<li>If the <code>bin</code> folder of the GNU Arm Embedded Toolchain does not exist in the PATH, it can be specified in the <code>SConstruct</code> file.</li>
<li>To build the project with the default debug configuration, execute: <code>scons -j8</code></li>
<li>To build all build configurations at once, execute: <code>scons --all -j8</code></li>
<li>To list all supported arguments, execute: <code>scons --help</code></li>
<li>The <code>build</code> subfolder should contain the generated outputs, organized in subfolders with the names of the build configurations.</li>
</ol>
<h1>References</h1>
<p>[1] Discovery kit with STM32L496AG MCU, <a href="https://www.st.com/en/evaluation-tools/32l496gdiscovery.html">https://www.st.com/en/evaluation-tools/32l496gdiscovery.html</a></p>
<p>[2] FreeRTOS Task Notifications, <a href="https://www.freertos.org/RTOS-task-notifications.html">https://www.freertos.org/RTOS-task-notifications.html</a></p>
<p>[3] Deferred Interrupt Processing, <a href="https://www.freertos.org/deferred_interrupt_processing.html">https://www.freertos.org/deferred_interrupt_processing.html</a> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
